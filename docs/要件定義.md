# 画像取得システム - 要件定義書

## 📋 プロジェクト概要

2ch(5ch)まとめサイト・ブログから、スレッド本文と画像を自動取得・整理するシステム

### システム名
まとめサイト向け画像・本文抽出システム  
（BeautifulSoup版 + Playwright版 併用構成）

### 目的
本システムは、まとめブログ等の記事URLから  
**画像および本文テキストを構造化して自動取得する**ことを目的とする。

主な利用目的は以下とする。
- YouTube動画台本作成
- 画像付き原稿・スクリプト生成
- クラウドソーシング案件の作業効率化
- 分業作業用素材の自動取得

---

## 🎯 ゴール

### 大分類
**指定したURLの画像と本文を取得してフォルダに出力する**

### 前提
- **対象サイト**: 2ch(5ch)のまとめサイト、ブログ
- **取得対象**: スレッド本文とスレッド内の画像をすべて取得
- **スレ主ID**: コメ主のIDも取得（デバイス変更でIDが変わることがあるため、スレ主と判断されるIDはすべて取得）
- **その他ID**: スレ主以外のIDは取得不要

### 制約要件
- **取得範囲**: スレッド本文のみを対象
- **除外対象**: 広告などの無関係な画像や本文は対象外

### 現在の問題点

#### 画像取得できないケース
以下のURLで画像が取得できていない：
- `https://tabinolog.com/archives/16141932.html`
- `https://tabinolog.com/archives/16142958.html`
- `https://tabinolog.com/archives/21661990.html`

#### 原因分析（コード分析結果）

現在のコード（`画像一括取得.py`）を分析した結果、以下の原因が考えられます：

**1. 要素選択の問題（391-412行目）**
- `main_article`の検索が失敗している可能性
  - セレクター: `"article.post, article.article, main#main.main article"`
  - 該当ページのHTML構造が異なる可能性
- `.t_h` / `.t_b` クラスが見つからない可能性
  - セレクター: `".entry-content .t_h, .entry-content .t_b, .article-body .t_h, .article-body .t_b, .t_h, .t_b"`
  - ページによってクラス名が異なる可能性

**2. 画像抽出ロジックの問題（84-213行目）**
- `extract_images_from_element`関数は`.t_b`要素内の画像を抽出
- `<img>`タグの`src`属性を取得（`data-src`, `data-original`, `data-lazy`, `data-image`にも対応）
- ただし、以下のケースで取得できない可能性：
  - 画像がJavaScriptで動的に生成される
  - 画像が`<picture>`タグや`<source>`タグ内にある
  - 画像がCSSの`background-image`で表示されている
  - 画像URLが相対パスで、正しく解決されていない

**3. スクロール・読み込みの問題（302-336行目）**
- 自動スクロールは実装されているが、以下の問題の可能性：
  - lazyload画像が完全に読み込まれる前にHTMLを取得している
  - スクロール待機時間（1500ms）が不十分
  - 画像が表示領域に入る前にHTMLを取得している

**4. 広告判定の問題（40-73行目）**
- `is_ad_image`関数で広告を除外しているが、誤判定の可能性：
  - スレッド本文内の画像が広告として誤判定されている
  - 画像サイズ（50x50未満）で除外されているが、実際の画像が小さい可能性

**5. 画像ダウンロードの問題（602-683行目）**
- ダウンロード時にエラーが発生している可能性：
  - 404エラーでスキップされている
  - タイムアウト（10秒）で失敗している
  - URL解決が正しく行われていない

**6. 画像URLの形式の問題**
- 相対パスが正しく解決されていない可能性
- 画像URLにクエリパラメータが含まれている場合の処理
- CDN経由の画像URLの処理

#### 理想とする動作（参考：Image Downloader）
- **Google Chrome拡張機能「Image Downloader」**のように、表示されている画像をすべて取得できる
- **ただし、スレッド本文内の画像のみを対象とする**
  - 広告、サイドバー、ヘッダー、フッターなどの無関係な画像は除外
  - `.t_h` / `.t_b` 構造内の画像のみを取得
  - スレッド投稿部分に含まれる画像を漏れなく取得

#### 要件として明確化すべき点
1. **画像取得の対象範囲の明確化**
   - スレッド本文（`.t_h` + `.t_b`）内の画像のみ
   - 広告エリア、サイドバー、ヘッダー/フッターは除外
   - ページ全体ではなく、スレッド投稿部分のみをスキャン

2. **画像取得方法の強化**
   - JavaScript実行後のDOMから画像を取得
   - lazyload画像の確実な取得
   - 動的に読み込まれる画像の取得
   - 各種画像形式への対応強化

3. **取得失敗時の対応**
   - 取得できない画像の原因分析
   - 代替取得方法の検討
   - エラーログの詳細化

#### 改善方針（原因別）

**原因1: 要素選択の問題**
- セレクターの柔軟性を向上
- 複数のセレクターパターンを試行
- ページ構造の自動検出機能の追加

**原因2: 画像抽出ロジックの問題**
- `<picture>`タグ、`<source>`タグへの対応
- CSS `background-image`の抽出（必要に応じて）
- 相対パスの確実な解決
- JavaScript実行後のDOMから直接画像を取得

**原因3: スクロール・読み込みの問題**
- 画像が完全に読み込まれるまで待機
- 各画像要素を個別にスクロールして表示
- 画像読み込み完了の確認（`complete`プロパティ）

**原因4: 広告判定の問題**
- スレッド本文内（`.t_b`）の画像は広告判定を緩和
- 画像サイズ判定の見直し
- 親要素のクラス名による判定の追加

**原因5: 画像ダウンロードの問題**
- エラーログの詳細化（どのURLで失敗したか記録）
- リトライ機能の追加
- 代替URLの試行

**原因6: 画像URLの形式の問題**
- URL解決ロジックの強化
- クエリパラメータの適切な処理
- CDN URLの対応

#### 解決アプローチの比較

**アプローチ①: 既存Pythonファイルの修正（推奨）**

**メリット**:
- ✅ 開発時間が短い（数時間〜数日）
- ✅ リスクが低い（既存機能への影響が限定的）
- ✅ 要件定義への適合性が高い（既に要件に基づいて実装済み）
- ✅ EXE化の継続（既存プロセスをそのまま使用）
- ✅ 段階的なアプローチが可能

**デメリット**:
- ❌ **想定外の構造のページの場合、画像が取得できない**
  - セレクターベースのアプローチのため、ページ構造が変わると対応が必要
  - 都度要件を変更する必要がある
  - 新しいサイト構造に対応するたびに修正が必要
- ❌ Image Downloader的な動作の実現が難しい
- ❌ 根本的な問題解決が難しい可能性

**実装難易度**: 低〜中  
**期待効果**: 原因1-3は高、原因4-5は中、原因6は低  
**保守性**: ページ構造の変更に応じて都度修正が必要

**アプローチ②: Image Downloaderコピーアプリ + 対象範囲限定**

**メリット**:
- ✅ **画像は全て取得できる（ページ構造に依存しない）**
  - 表示されている画像をすべて取得できる
  - ページ構造が変わっても画像取得は確実
  - 想定外の構造のページでも画像を取得可能
- ✅ 根本的な解決（既存コードの制約を受けない）
- ✅ 動作の確実性（Image Downloaderの実績ある動作）

**デメリット**:
- ❌ **要件に合わせた絞り込みが必要になる**
  - ページ全体の画像を取得してから、スレッド本文のみに絞り込む必要がある
  - 広告、サイドバー、ヘッダー/フッターの除外ロジックが必要
  - `.t_h` / `.t_b` 構造内のみを対象とするフィルタリングが必要
- ❌ 開発時間が長い（数週間〜数ヶ月）
- ❌ リスクが高い（新規開発によるバグの可能性）
- ❌ 要件定義への適合性（後から仕様を追加する必要がある）
- ❌ 二重開発の可能性（既存機能の再実装）
- ❌ EXE化の再検討が必要

**実装難易度**: 高  
**期待効果**: 画像取得の確実性は非常に高いが、要件定義に合わせた調整が必要  
**保守性**: 画像取得は確実だが、フィルタリングロジックの調整が必要

**決定**: **アプローチ①（既存Pythonファイルの修正）で対応**

**理由**:
1. 段階的なアプローチが可能（まず簡単な修正、次にやや複雑な修正）
2. リスクが低い（既存機能への影響が限定的）
3. 開発効率が高い（既存コードベースを活用）
4. 要件定義への適合性が高い（既にスレッド本文のみを対象とする仕様が実装済み）

**アプローチ①の課題**:
- 想定外の構造のページの場合、画像が取得できない
- 都度要件を変更する必要がある（セレクターの追加・修正）

**アプローチ②を検討すべきケース**:
- アプローチ①のフェーズ1, 2で解決しない場合
- 原因6（DOM直接取得）が主な原因であることが判明した場合
- **複数のサイトで想定外の構造が頻発し、都度修正が困難な場合**
- **ページ構造に依存せず、確実に画像を取得したい場合**

**アプローチ②の課題**:
- 画像は全て取得できるが、要件に合わせた絞り込みが必要になる
- ページ全体の画像を取得してから、スレッド本文のみにフィルタリングする必要がある

---

## 🎯 アプローチ①での実装計画

### 実装方針
既存の`画像一括取得.py`を段階的に修正して、画像取得機能を改善する。

### フェーズ1: 簡単な修正（優先度: 最高）

#### 1-1. 原因1: 要素選択の改善
**目標**: 3つの問題URLで要素が正しく選択されるようにする

**実装内容**:
- [ ] デバッグログの追加
  - どのセレクターで要素が見つかったか記録
  - 見つからなかった場合の詳細ログ
- [ ] セレクターの追加・修正
  - tabinolog.com用のセレクターを追加
  - フォールバックセレクターの追加
- [ ] ページ構造の自動検出
  - 複数のセレクターパターンを試行
  - 最も多くの要素が見つかるセレクターを採用

**期待効果**: 3つのURLで要素が選択され、画像取得の前提条件を満たす

#### 1-2. 原因2: URL解決の確認
**目標**: 画像URLが正しく解決されるようにする

**実装内容**:
- [ ] URL解決ロジックの確認
  - `urljoin`の動作確認
  - ベースURLの確認
- [ ] デバッグログの追加
  - 元のURLと解決後のURLを記録
  - 解決に失敗した場合の詳細ログ

**期待効果**: 画像URLが正しく解決され、ダウンロード可能になる

#### 1-3. 原因3: 広告判定の見直し
**目標**: スレッド本文内の画像が広告として誤判定されないようにする

**実装内容**:
- [ ] `.t_b`内の画像は広告判定を緩和
  - `.t_b`要素内の画像は広告判定をスキップまたは緩和
  - 親要素が`.t_b`の場合は広告判定を緩和
- [ ] 画像サイズ判定の見直し
  - スレッド本文内の画像はサイズ判定を緩和
  - 最小サイズの閾値を調整

**期待効果**: スレッド本文内の画像が誤って除外されなくなる

**判断基準**: フェーズ1完了後、3つの問題URLで画像が取得できるか確認

---

### フェーズ2: やや複雑な修正（フェーズ1で解決しない場合）

#### 2-1. 原因4: lazyload画像の読み込み改善
**目標**: lazyload画像が確実に読み込まれるようにする

**実装内容**:
- [ ] 画像読み込み完了の確認
  - 各画像要素の`complete`プロパティを確認
  - 画像が読み込まれるまで待機
- [ ] スクロール処理の改善
  - 各画像要素を個別にスクロールして表示
  - 画像が表示領域に入るまで待機
- [ ] 待機時間の調整
  - スクロール待機時間の最適化
  - 画像読み込み待機時間の追加

**期待効果**: lazyload画像が確実に読み込まれ、取得できるようになる

#### 2-2. 原因5: 画像属性の取得拡張
**目標**: すべての画像属性からURLを取得できるようにする

**実装内容**:
- [ ] 追加属性への対応
  - `data-srcset`, `srcset`属性の対応
  - `<picture>`タグ、`<source>`タグへの対応
- [ ] 画像URL抽出ロジックの強化
  - 複数の属性を順次確認
  - 最適な画像URLを選択

**期待効果**: 様々な形式の画像URLに対応できるようになる

**判断基準**: フェーズ2完了後、3つの問題URLで画像が取得できるか確認

---

### フェーズ3: 大きな変更（フェーズ1, 2で解決しない場合）

#### 3-1. 原因6: DOM直接取得への変更
**目標**: Playwrightで直接画像を取得する方式に変更

**実装内容**:
- [ ] Playwrightで直接画像を取得
  - `page.query_selector_all("img")`を使用
  - 表示されている画像を直接取得
- [ ] スレッド本文内の画像のみにフィルタリング
  - `.t_h` / `.t_b` 構造内の画像のみを対象
  - 広告、サイドバー、ヘッダー/フッターを除外
- [ ] 既存機能との統合
  - 本文抽出機能との統合
  - スレ主ID判定機能との統合

**期待効果**: Image Downloader的な動作を実現し、画像取得の確実性が向上

**判断基準**: フェーズ3完了後、3つの問題URLで画像が取得できるか確認

---

### 実装時の注意事項

1. **段階的な実装**
   - フェーズ1から順に実装
   - 各フェーズで動作確認
   - 問題が解決した時点で終了

2. **デバッグログの活用**
   - 各フェーズでデバッグログを追加
   - 原因を特定しやすくする
   - 問題が解決しない場合の原因分析に活用

3. **既存機能の維持**
   - 既存の動作を維持しながら改善
   - 既存のテストケースで動作確認
   - 既存のEXE化プロセスを維持

4. **要件定義への反映**
   - 修正内容を要件定義に反映
   - 新しいセレクターやロジックを文書化
   - 将来の保守に備える

---

## 📤 出力形式仕様

### posts.txt のフォーマット

```
タイトル
ID:スレ主ID1
ID:スレ主ID2
ID:スレ主IDn
（空行）
レス番号: 名前 日時 ID:投稿者ID
画像1.jpg
コメント本文
（空行）
レス番号: 名前 日時 ID:投稿者ID
コメント本文
（空行）
...
```

### 実例（実際の出力結果より）

```
【4月】青森弘前ひとり旅  |  旅のろぐ
ID:2dA8YojA0
ID:J56CH5iy0
ID:YxS6KPQSr

1: ぽん助 2022/04/24(日) 17:19:09.443 ID:YxS6KPQSr
今日から一泊二日でひとり旅
記録も兼ねて弘前の桜を中心に写真も貼っていこうと思うので、良かったら見ていってください
色々話しかけてくれると嬉しい！

6: ぽん助 2022/04/24(日) 17:23:16.969 ID:YxS6KPQSr
今日の行程は
芦野公園行く予定が、新青森でラーメン食べてたら電車逃して断念
→予定変更して弘前に行こうとするが電車１時間待ち
→弘前公園外濠で桜撮影&お散歩とか喫茶店
→これからお買い物して旅館へ
旅館には看板ネッコがいるらしいから楽しみや

7: 以下、5ちゃんねるからVIPがお送りします 2022/04/24(日) 17:23:23.112 ID:Aru1ynMO0
どこから来たの

9: ぽん助 2022/04/24(日) 17:24:43.796 ID:YxS6KPQSr
画像1.jpg
画像2.jpg
新青森のラーメン屋
これで旅程狂ったけど美味かった
```

### 画像ファイルの命名規則

- **形式**: `画像n.拡張子`（例: `画像1.jpg`, `画像2.png`）
- **保存先**: `images/` フォルダ
- **連番**: スレッド内で登場順に1から採番
- **対応関係**: `posts.txt` 内の `画像1.jpg` と `images/画像1.jpg` が一致

---

## 📥 入力要件

### 入力ファイル
- `urls.txt`

### 入力形式
- テキストファイル形式（UTF-8）
- 1行につき1URLを記載する

### 入力URLの条件
- 公開されているWebページであること
- ログイン・認証を必要としないページのみ対象
- JavaScript 実行が必要なページも対象（Playwright版）

### 入力件数
- 件数制限は設けない
- 実行環境の性能に依存する

---

## 🔍 スレ主ID判定ロジック

### 判定基準

1. **確定条件**: 1番目のレス（最初のコメント）の投稿者IDは必ずスレ主
2. **追加条件**: HTML上でIDが色付き表示されているものをスレ主として判定
   - デバイス変更等でIDが変わる可能性があるため、複数IDを取得
3. **除外**: スレ主以外の一般投稿者IDは取得不要

### 実装上の注意
- 色付きIDの判定は、HTMLのクラス名やスタイル属性から判断
- 最低でも1番レスのIDは必ず取得する

---

## 📂 出力ファイル構成

```
result_js/
└── [ページタイトル]/
    ├── posts.txt          # スレッドテキスト（タイトル、スレ主ID、全レス）
    ├── script.csv         # （今後定義予定）
    └── images/
        ├── 画像1.jpg
        ├── 画像2.png
        └── ...
```

### フォルダ命名ルール
- HTML の `<title>` タグを元に生成
- 記号・空白は `_` に変換
- 最大50文字
- 同名フォルダが存在する場合は削除して再生成（上書き）

### posts.txt の構成要素

1. **ヘッダー部**
   - 1行目: スレッドタイトル
   - 2行目以降: スレ主のID一覧（`ID:xxxxx` 形式）
   - 空行

2. **レス本文部**（各レスごとに繰り返し）
   - レスヘッダ: `番号: 名前 日時 ID:投稿者ID`
   - 画像参照: `画像n.jpg`（画像がある場合のみ）
   - コメント本文（画像がないレスも出力対象）
   - 空行

---

## 🔧 技術スタック

### システム構成
本システムは以下の 2系統構成 とする。

| 区分 | 内容 |
|------|------|
| 軽量版 | BeautifulSoup を用いたHTML解析 |
| 重装版 | Playwright による JavaScript 実行 |

### 軽量版（BeautifulSoup版）
- JavaScriptを実行しない
- 静的HTML構造のまとめサイト向け
- 処理速度が高速
- exe化が可能
- 第三者配布を想定

### 重装版（Playwright版）
- JavaScriptを実行してDOMを構築
- 自動スクロールにより lazyload に対応
- imgur URL 変換に対応
- 取得率を最優先
- 原則、開発者本人利用を前提とする
  （Playwright・ブラウザエンジンの事前インストールが必要）

### 言語・ライブラリ
- **Python**: 動作確認済みのバージョンを使用（2025年12月16日現在で適切なバージョン）
  - **注意**: ライブラリの互換性の問題でダウングレードした経験があるため、動作確認済みのバージョンを使用すること
  - バージョン変更時は必ずライブラリの互換性を確認すること
  - **重要**: 「Python 3.5以上」は「3.5以降」という意味で、3.5にダウングレードする必要はありません
- **Playwright** - JavaScript実行対応ブラウザ自動化
- **BeautifulSoup4** - HTML解析
- **Requests** - 画像ダウンロード
- **lxml** - HTML/XML解析

### 依存パッケージ
```
playwright
beautifulsoup4
requests
lxml
```

### Pythonバージョン要件の詳細

#### 推奨バージョン
- **現在の推奨**: 実際に動作確認済みのPythonバージョンを使用（2025年12月16日現在で適切なバージョン）
- **注意**: ライブラリの互換性の問題でダウングレードした経験があるため、動作確認済みのバージョンを使用すること

#### ライブラリの互換性
使用している主要ライブラリの互換性：
- **Playwright**: Python 3.8以上をサポート（ただし、最新版はPython 3.10以上を推奨）
- **BeautifulSoup4**: Python 3.6以上をサポート
- **requests**: Python 3.7以上をサポート
- **lxml**: Python 3.5以上をサポート（3.5以降のすべてのバージョンで使用可能）
  - **注意**: 「3.5以上」は「3.5以降」という意味で、3.5にダウングレードする必要はありません
  - Python 3.6, 3.7, 3.8, 3.9, 3.10, 3.11, 3.12など、すべて3.5以上のバージョンでlxmlは使用可能です

#### 互換性の理解
- **「Python 3.5以上」の意味**: 3.5以降のすべてのバージョンで使用可能
- **ダウングレード不要**: 3.5にダウングレードする必要はありません
- **現在のバージョンで問題なし**: 動作確認済みのPythonバージョン（2025年12月16日現在）でlxmlは正常に動作します

#### 注意事項
- **ライブラリの起動問題**: 過去にライブラリの起動ができず、Pythonバージョンをダウングレードした経験がある
- **動作確認**: 現在使用しているPythonバージョンが適切であることを確認済み（2025年12月16日現在）
- **バージョンアップ時の注意**: Pythonバージョンを変更する場合は、必ずライブラリの互換性を確認すること
- **EXE化**: PyInstallerによるEXE化も考慮し、互換性のあるバージョンを使用すること

#### 推奨事項
1. **現在のPythonバージョンを維持**: 動作確認済みのバージョンを使用
2. **バージョン変更時の確認**: バージョンを変更する場合は、すべてのライブラリが正常に動作することを確認
3. **requirements.txtの確認**: 依存パッケージのバージョンを固定して互換性を確保

---

## ⚙️ 主要機能

### 1. スレッド本文抽出
- ✅ タイトル取得
- ✅ スレ主ID自動判定（色付きID + 1番レスID）
- ✅ レスヘッダ完全取得（番号、名前、日時、ID）
- ✅ コメント本文取得
- ✅ 広告・無関係テキスト除外

### 2. 画像取得
- ✅ スレッド内画像のみ取得（広告除外）
- ✅ 登場順に連番付与（`画像1.jpg`, `画像2.jpg`...）
- ✅ posts.txtとの対応関係を維持
- ✅ 複数形式対応（jpg, png, gif, webp）
- ❌ **スレッド本文内の画像を漏れなく取得する機能の強化が必要**
  - Image Downloaderのように、表示されている画像をすべて取得できるようにする
  - ただし、スレッド投稿部分（`.t_h` / `.t_b`）のみを対象とする

### 3. スレ主ID判定
- ✅ 1番レスID（確定）
- ✅ HTML上の色付きID検出
- ✅ 複数ID対応（デバイス変更対応）

### 4. マルチサイト対応
- ✅ パターン1: `t_h` / `t_b` 構造
- ✅ パターン2: 2chまとめブログ形式
- ✅ フォールバック: 汎用検出

### 6. 本文と画像の紐付け
- ✅ `.t_h` + `.t_b` を1レスとして扱う
- ✅ 画像がレス内または直後に存在する場合、同一レスの本文を紐付ける
- ✅ **本文のみ（画像なし）のレスも出力対象とする**

### 5. エラーハンドリング
- ✅ Windows環境でのUnicode対応
- ✅ タイムアウト時も部分取得を試行
- ✅ ダウンロード失敗時はスキップして継続

---

## 📊 処理フロー

```
1. URLリスト読み込み (urls.txt)
   ↓
2. 各URLに対して処理
   ↓
3. ページ読み込み（Playwright）
   ├─ JavaScript実行
   ├─ 自動スクロール（Lazy Load対応）
   └─ DOM取得
   ↓
4. HTML解析（BeautifulSoup）
   ├─ タイトル抽出
   ├─ スレ主ID判定
   ├─ レス構造解析
   └─ 画像URL収集
   ↓
5. データ整形
   ├─ posts.txt生成
   │  ├─ ヘッダー部（タイトル + スレ主ID）
   │  └─ レス本文部（ヘッダ + 画像参照 + 本文）
   └─ 画像ダウンロード（images/画像n.jpg）
   ↓
6. ファイル保存
   └─ result_js/[タイトル]/ に出力
```

---

## ✅ 現在の実装状況

### 実装済み機能（v2.0）
- ✅ 基本的なスクレイピング機能
- ✅ JavaScript対応（Playwright）
- ✅ 自動スクロール（Lazy Load対応）
- ✅ 広告フィルター
- ✅ Windows環境Unicode対応
- ✅ マルチサイト構造対応

### 未実装機能（要対応）
- ❌ **スレ主ID判定機能**
  - 1番レスIDの自動取得
  - 色付きID検出ロジック
  - 複数スレ主ID対応
- ❌ **posts.txt の新フォーマット対応**
  - ヘッダー部（タイトル + スレ主ID）
  - レスヘッダ完全取得
  - 画像参照形式の変更（`画像_n.jpg`）
- ❌ **画像命名規則の統一**
  - `画像1.jpg` 形式で統一（アンダースコアなし）
- ❌ **レス構造の正確な抽出**
  - レス番号の確実な取得
  - 空行の適切な挿入

---

## 🔄 今後の実装計画

### フェーズ1: テキスト抽出機能の完成
**優先度: 最高**

- [ ] スレ主ID判定ロジック実装
  - HTML解析で色付きID検出
  - 1番レスID自動取得
  - 重複排除処理
- [ ] posts.txt フォーマット刷新
  - ヘッダー部の実装
  - レスヘッダ完全取得
  - 画像参照形式変更
- [ ] レス構造の正確な解析
  - レス番号、名前、日時、IDの分離抽出
  - コメント本文の正確な取得
  - 空行制御

### フェーズ2: 画像取得機能の最適化
**優先度: 高**（Image Downloaderを参考に強化・原因分析に基づく改善）

#### 2-1. 要素選択の改善（原因1対応）
- [ ] **セレクターの柔軟性向上**
  - 複数のセレクターパターンを試行
  - ページ構造の自動検出機能
  - `.t_h` / `.t_b` 以外のクラス名にも対応
- [ ] **要素検出の強化**
  - `main_article`検索の改善
  - フォールバックセレクターの追加

#### 2-2. 画像抽出ロジックの強化（原因2対応）
- [ ] **スレッド本文内の画像を漏れなく取得**
  - Image Downloaderのように表示されている画像をすべて取得
  - ただし、`.t_h` / `.t_b` 構造内のみを対象とする
  - 広告、サイドバー、ヘッダー/フッターは除外
- [ ] **各種画像形式への対応**
  - `<picture>`タグ、`<source>`タグへの対応
  - CSS `background-image`の抽出（必要に応じて）
  - 相対パスの確実な解決
- [ ] **JavaScript実行後のDOMから直接画像を取得**
  - Playwrightの`page.query_selector_all`を使用
  - 表示されている画像を直接取得

#### 2-3. スクロール・読み込みの改善（原因3対応）
- [ ] **画像読み込みの確実な待機**
  - 画像が完全に読み込まれるまで待機
  - 各画像要素を個別にスクロールして表示
  - 画像読み込み完了の確認（`complete`プロパティ）
- [ ] **lazyload画像の完全な取得**
  - スクロール待機時間の調整
  - 画像が表示領域に入るまで待機

#### 2-4. 広告判定の改善（原因4対応）
- [ ] **広告判定ロジックの見直し**
  - スレッド本文内（`.t_b`）の画像は広告判定を緩和
  - 画像サイズ判定の見直し
  - 親要素のクラス名による判定の追加

#### 2-5. 画像ダウンロードの改善（原因5,6対応）
- [ ] **エラーハンドリングの強化**
  - エラーログの詳細化（どのURLで失敗したか記録）
  - リトライ機能の追加
  - 代替URLの試行
- [ ] **URL解決の改善**
  - URL解決ロジックの強化
  - クエリパラメータの適切な処理
  - CDN URLの対応

#### 2-6. その他
- [ ] 画像とテキストの完全対応
- [ ] 画像命名規則の統一（`画像1.jpg`）
- [ ] **取得失敗時の原因分析とログ出力**
  - 取得できない画像のURLと原因を記録
  - エラーレポートの生成

### フェーズ3: script.csv の実装
**優先度: 中**（仕様未定）

- [ ] 仕様策定
- [ ] CSV出力機能実装

### フェーズ4: 追加機能・最適化
**優先度: 低**

- [ ] エラーログの詳細化
- [ ] 実行進捗表示の改善
- [ ] 並列ダウンロード対応
- [ ] GUI版の作成

---

## 📝 詳細仕様

### スレ主ID判定の詳細

#### 判定条件の優先順位
1. **最優先**: 1番レス（最初のコメント）の投稿者ID
2. **追加判定**: HTML上で色付き表示されているID
   - クラス名に `op`, `thread-creator`, `author` などが含まれる
   - スタイルで `color` が指定されている
   - 特定の背景色が設定されている

#### 注意事項
- デバイス変更やネットワーク切り替えでIDが変わる可能性
- 同一スレ主が複数のIDで投稿している場合がある
- すべてのスレ主IDを漏れなく取得する必要がある

### 画像とテキストの対応関係

#### 重要な仕様
- **posts.txt内の画像参照**と**imagesフォルダの画像ファイル**が完全に一致
- 例: `posts.txt`に`画像1.jpg`と記載 → `images/画像1.jpg`が存在
- 連番は**スレッド全体**での出現順（レスごとではない）
- 画像がないレスには画像参照行を出力しない
- **本文のみ（画像なし）のレスも出力対象とする**

#### 実装上の注意
- 広告画像は取得しない（連番にも含めない）
- スレッド本文内の画像のみをカウント
- ダウンロード失敗した画像も連番から除外
- 1レス内に複数画像がある場合、すべての画像を連番で出力する（例：9番レスに画像1.jpgと画像2.jpgが含まれる）

### レスヘッダの構成要素

完全な形式で取得：
```
[レス番号]: [名前] [日時] ID:[投稿者ID]
```

各要素の詳細：
- **レス番号**: 実際のレス番号（連番ではない。例: `1`, `6`, `7`, `9`, `13`）
- **名前**: 投稿者名（例: `名無しさん＠おーぷん`, `ぽん助`, `以下、5ちゃんねるからVIPがお送りします`）
- **日時**: 完全な日時情報（例: `2022/04/24(日) 17:19:09.443`, `25/01/23(木) 20:12:38`）
- **ID**: `ID:` プレフィックス付き（例: `ID:YxS6KPQSr`, `ID:Aru1ynMO0`）

### 本文取得仕様

#### 対象HTML要素
- `.t_h` ：レスヘッダ（番号・名前・日時・ID）
- `.t_b` ：レス本文

#### テキスト整形ルール
- HTMLタグは除去
- `<br>` / `<p>` は改行に変換
- 装飾・色・UI文字列は除去
- 純テキストのみ出力

### 画像取得の対象範囲（重要）

#### 取得対象
- **スレッド投稿部分のみ**（`.t_h` + `.t_b` 構造内の画像）
- 各レス（`.t_h` / `.t_b`）内に含まれる画像
- レス本文（`.t_b`）内の `<img>` タグ
- レス本文（`.t_b`）内の `<a>` タグでリンクされている画像
- lazyload画像（data-src等）
- 動的に読み込まれる画像（JavaScript実行後）

#### 除外対象
- 広告エリアの画像
- サイドバーの画像
- ヘッダー/フッターの画像
- ナビゲーションメニューの画像
- 関連記事エリアの画像
- RSSフィードエリアの画像
- その他、スレッド投稿部分（`.t_h` / `.t_b`）外の画像

#### 取得方法の要件
- **Image Downloaderを参考に、表示されている画像をすべて取得**
- JavaScript実行後のDOMから画像を取得
- 自動スクロールにより、画面外の画像も読み込んで取得
- スレッド投稿部分（`.t_h` / `.t_b`）のみをスキャン対象とする

### imgur画像の扱い

#### 取得可能条件
HTML上に以下の形式が存在する場合：
```html
<a href="https://imgur.com/xxxx">
```
上記を以下に変換して取得する：
```
https://i.imgur.com/xxxx.jpg
```

#### 取得不可条件（仕様）
- imgur JS embed（iframe 内完結）
- HTML上に URL / ID 情報が存在しないもの

---

## ⚙️ 非機能要件

### 性能
- 軽量版：高速
- Playwright版：低速（JS実行・スクロールあり）

### 実行環境
- Windows OS
- Python 実行環境
- Playwright版は事前セットアップ必須

### 配布方針
- 軽量版：exe化して配布可能
- Playwright版：配布非推奨（開発者専用）

### エラーハンドリング
- URL単位で処理を実行
- 1URL失敗しても全体処理は継続
- タイムアウト・取得不可時はログ出力のみ行う

### 取得不可ケース（仕様）
以下は仕様上、取得不可とする。
- imgur JS embed（iframe 内完結）
- HTML上に画像URLが存在しないケース
- DOM構築不能なページ（Cloudflare等）

### 画像取得の問題点と改善要件

#### 現在の問題
- 特定のURL（tabinolog.comの一部記事）で画像が取得できていない
- スレッド本文内の画像が漏れている可能性

#### 理想の動作（Image Downloaderを参考）
- **ページに表示されている画像をすべて取得できる**
- **ただし、スレッド投稿部分（`.t_h` / `.t_b`）のみを対象とする**
- 広告、サイドバー、ヘッダー/フッターは除外

#### 改善要件
1. **画像取得範囲の明確化**
   - スレッド本文（`.t_h` + `.t_b`）内の画像のみを対象
   - ページ全体ではなく、投稿部分のみをスキャン
   - 広告エリアの除外ロジックの強化

2. **画像取得方法の強化**
   - JavaScript実行後のDOMから確実に画像を取得
   - lazyload画像の完全な取得
   - 動的読み込み画像の取得
   - 各種画像形式への対応（jpg, png, gif, webp, svg等）

3. **取得失敗時の対応**
   - 取得できない画像の原因をログに記録
   - 代替取得方法の試行
   - エラーレポートの生成

---

## 🎯 成功基準

### 必須要件
- ✅ スレッドタイトルが正確に取得できる
- ✅ すべてのスレ主IDが漏れなく取得できる
- ✅ 全レスが順番通りに取得できる
- ✅ レスヘッダが完全な形式で取得できる
- ✅ スレッド内の画像がすべて取得できる（広告除外）
- ✅ 画像とテキストの対応が正確
- ✅ posts.txtのフォーマットが仕様通り

### 品質要件
- 広告画像の混入率: 0%
- スレッド内画像の取得率: 95%以上
- スレ主ID検出率: 100%（最低でも1番レスIDは必須）
- レスの取得漏れ: 0件

---

## 📞 サポート・問い合わせ

問題が発生した場合：
1. エラーログ（`log_js.txt`）を確認
2. Pythonバージョンを確認（動作確認済みのバージョンを使用しているか確認）
3. 依存パッケージを再インストール
4. ライブラリの互換性を確認（過去にライブラリの起動問題でダウングレードした経験があるため）

---

## 📝 注意事項

### 法的・倫理的配慮
- スクレイピング対象サイトの利用規約を必ず確認
- robots.txt の遵守
- サーバーへの過度な負荷を避ける
- 著作権・肖像権の尊重

### 技術的制約
- JavaScript無効化サイトは対象外
- CAPTCHA実装サイトは取得不可
- 動的生成画像は一部取得漏れの可能性

---

## 📚 参考資料

### 理想の出力例
- 参照ファイル: `c:\Users\81806\Desktop\作成中\result_js\美味しい餅のお料理_作り方を教えるよ♪_明日は何を食べようか\posts.txt`
- この形式を目標として実装を進める

### 対応確認済みサイト
- ✅ oryouri.2chblog.jp（お料理速報）
- ✅ tabinolog.com（旅のろぐ）
- ✅ gfoodd.com（明日は何を食べようか）

### 実際の出力例
- 入力URL: `https://tabinolog.com/archives/post-318497.html`
- 出力フォルダ: `result_js/OLD/【4月】青森弘前ひとり旅_旅のろぐ/`
- この出力結果を基準として仕様を確認・更新

### 問題のあるURL（画像取得できないケース）
- `https://tabinolog.com/archives/16141932.html`
- `https://tabinolog.com/archives/16142958.html`
- `https://tabinolog.com/archives/21661990.html`
- これらのURLで画像が取得できていない原因を分析し、改善要件に反映する必要がある

### 参考：Image Downloader
- **Google Chrome拡張機能「Image Downloader」**の動作を参考とする
- ページに表示されている画像をすべて取得できる機能
- **ただし、本システムではスレッド投稿部分（`.t_h` / `.t_b`）のみを対象とする**
- 広告、サイドバー、ヘッダー/フッターなどの無関係な画像は除外

---

**最終更新**: 2025年1月  
**バージョン**: 4.0（最新仕様反映・実出力例に基づく更新）  
**ステータス**: 仕様確定 → 実装フェーズ1へ移行予定

