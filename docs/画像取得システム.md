# 画像取得システム 要件定義書（As-Is／現行仕様）

---

## 1. システム概要

### 1.1 システム名
まとめサイト向け画像・本文抽出システム  
（BeautifulSoup版 + Playwright版 併用構成）

---

### 1.2 目的

本システムは、まとめブログ等の記事URLから  
**画像および本文テキストを構造化して自動取得する**ことを目的とする。

主な利用目的は以下とする。

- YouTube動画台本作成
- 画像付き原稿・スクリプト生成
- クラウドソーシング案件の作業効率化
- 分業作業用素材の自動取得

---

## 2. 入力要件

### 2.1 入力ファイル

- `urls.txt`

---

### 2.2 入力形式

- テキストファイル形式（UTF-8）
- 1行につき1URLを記載する

```txt
https://example.com/post-xxxx.html
https://example.com/post-yyyy.html
```

### 2.3 入力URLの条件

- 公開されているWebページであること
- ログイン・認証を必要としないページのみ対象
- JavaScript 実行が必要なページも対象（Playwright版）

### 2.4 入力件数

- 件数制限は設けない
- 実行環境の性能に依存する

---

## 3. システム構成

### 3.1 全体構成

本システムは以下の 2系統構成 とする。

| 区分 | 内容 |
|------|------|
| 軽量版 | BeautifulSoup を用いたHTML解析 |
| 重装版 | Playwright による JavaScript 実行 |

### 3.2 軽量版（BeautifulSoup版）

- JavaScriptを実行しない
- 静的HTML構造のまとめサイト向け
- 処理速度が高速
- exe化が可能
- 第三者配布を想定

### 3.3 重装版（Playwright版）

- JavaScriptを実行してDOMを構築
- 自動スクロールにより lazyload に対応
- imgur URL 変換に対応
- 取得率を最優先
- 原則、開発者本人利用を前提とする
  （Playwright・ブラウザエンジンの事前インストールが必要）

---

## 4. 出力要件

### 4.1 出力ディレクトリ構成

```
result_js/
  └ 記事タイトル/
      ├ posts.txt
      └ images/
          ├ 画像1.jpg
          ├ 画像2.jpg
          ├ 画像3.jpg
          └ ...
```

### 4.2 フォルダ命名ルール

- HTML の `<title>` タグを元に生成
- 記号・空白は `_` に変換
- 最大50文字
- 同名フォルダが存在する場合は削除して再生成（上書き）

### 4.3 出力ファイル構成

```
result_js/
└── [ページタイトル]/
    ├── posts.txt          # スレッドテキスト（タイトル、スレ主ID、全レス）
    └── images/
        ├── 画像1.jpg
        ├── 画像2.png
        └── ...
```

---

## 5. テキスト出力仕様（posts.txt）

### 5.1 出力フォーマット

posts.txtは以下の構成とする。

1. **ヘッダー部**
   - 1行目: スレッドタイトル
   - 2行目以降: スレ主のID一覧（`ID:xxxxx` 形式）
   - 空行

2. **レス本文部**（各レスごとに繰り返し）
   - レスヘッダ: `番号: 名前 日時 ID:投稿者ID`
   - 画像参照: `画像n.jpg`（画像がある場合のみ）
   - コメント本文（画像がないレスも出力対象）
   - 空行

### 5.2 出力順序（確定仕様）

```
タイトル
ID:スレ主ID1
ID:スレ主ID2
（空行）
レス番号: 名前 日時 ID:投稿者ID
画像1.jpg（画像がある場合のみ）
コメント本文
（空行）
レス番号: 名前 日時 ID:投稿者ID
コメント本文（画像がないレスも出力）
（空行）
...
```

### 5.3 出力例

```
美味しい餅のお料理、作り方を教えるよ♪ | 明日は何を食べようか
ID:7MaV
ID:85LM
ID:MQpT

1: 名無しさん＠おーぷん 25/01/23(木) 20:12:38 ID:85LM
作り方を教えるよ♪

2: 名無しさん＠おーぷん 25/01/23(木) 20:13:08 ID:85LM
画像1.jpg

3: 名無しさん＠おーぷん 25/01/23(木) 20:13:47 ID:85LM
画像2.jpg
斬る

4: 名無しさん＠おーぷん 25/01/23(木) 20:14:06 ID:MQpT
このスレワイしか見てないけど頑張れ
```

---

## 6. 本文取得仕様

### 6.1 対象HTML要素

- `.t_h` ：レスヘッダ（番号・名前・日時・ID）
- `.t_b` ：レス本文

### 6.2 テキスト整形ルール

- HTMLタグは除去
- `<br>` / `<p>` は改行に変換
- 装飾・色・UI文字列は除去
- 純テキストのみ出力

---

## 7. 画像取得仕様

### 7.1 命名規則

- ページ上の出現順に連番付与
- レス番号とは無関係

```
画像1.jpg
画像2.jpg
画像3.jpg
```

### 7.2 対応画像タイプ

| 画像タイプ | 取得可否 |
|-----------|---------|
| 静的 `<img src>` | 可 |
| lazyload（data-src等） | 可 |
| imgur URL直書き | 可（変換処理あり） |
| imgur JS embed | 不可（仕様） |

---

## 8. imgur画像の扱い

### 8.1 取得可能条件

HTML上に以下の形式が存在する場合：

```html
<a href="https://imgur.com/xxxx">
```

上記を以下に変換して取得する：

```
https://i.imgur.com/xxxx.jpg
```

### 8.2 取得不可条件（仕様）

- imgur JS embed（iframe 内完結）
- HTML上に URL / ID 情報が存在しないもの

---

## 9. 本文と画像の紐付けルール

- `.t_h` + `.t_b` を1レスとして扱う
- 画像がレス内または直後に存在する場合、同一レスの本文を紐付ける
- **本文のみ（画像なし）のレスも出力対象とする**

---

## 10. スレ主ID判定ロジック

### 判定基準

1. **確定条件**: 1番目のレス（最初のコメント）の投稿者IDは必ずスレ主
2. **追加条件**: HTML上でIDが色付き表示されているものをスレ主として判定
   - デバイス変更等でIDが変わる可能性があるため、複数IDを取得
3. **除外**: スレ主以外の一般投稿者IDは取得不要

### 実装上の注意

- 色付きIDの判定は、HTMLのクラス名やスタイル属性から判断
- 最低でも1番レスのIDは必ず取得する
- 取得したスレ主IDはposts.txtのヘッダー部に記載する

---

## 11. エラーハンドリング

- URL単位で処理を実行
- 1URL失敗しても全体処理は継続
- タイムアウト・取得不可時はログ出力のみ行う

---

## 12. 取得不可ケース（仕様）

以下は仕様上、取得不可とする。

- imgur JS embed（iframe 内完結）
- HTML上に画像URLが存在しないケース
- DOM構築不能なページ（Cloudflare等）

---

## 13. 非機能要件

### 12.1 性能

- 軽量版：高速
- Playwright版：低速（JS実行・スクロールあり）

### 12.2 実行環境

- Windows OS
- Python 実行環境
- Playwright版は事前セットアップ必須

### 12.3 配布方針

- 軽量版：exe化して配布可能
- Playwright版：配布非推奨（開発者専用）

---

## 14. 将来的な拡張候補（To-Be）

- レスヘッダの構造化（番号／名前／日時／ID分解）
- 画像0件URLの自動レポート出力
- posts.txt → CSV 変換
- Dify / WebAPI化
- Slack / Teams 連携

---

## 15. 要件定義まとめ

本システムは、HTML上に存在する情報を最大限自動取得し、構造上取得不可能な要素は仕様として明確に切り分ける実務向け画像・本文抽出システムである。
