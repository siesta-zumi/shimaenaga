# 開発ナレッジ - 画像取得システム

**最終更新**: 2025年12月16日  
**目的**: 開発・検証過程で得られた知見をまとめ、次回以降の開発・修正に活用する

---

## 📋 目次

1. [問題発見と原因分析](#問題発見と原因分析)
2. [アプローチ比較と意思決定](#アプローチ比較と意思決定)
3. [実装過程と課題](#実装過程と課題)
4. [最終的な解決策](#最終的な解決策)
5. [システム設計の決定](#システム設計の決定)
6. [今後の開発・修正時の注意点](#今後の開発修正時の注意点)

---

## 🔍 問題発見と原因分析

### 発見された問題

**3つのURLで画像が取得できない問題**:
- `https://tabinolog.com/archives/16141932.html`
- `https://tabinolog.com/archives/16142958.html`
- `https://tabinolog.com/archives/21661990.html`

### 原因分析結果

#### 原因1: 要素選択の問題（優先度: 高）
- **問題**: セレクターが該当ページの構造と一致していない
- **修正難易度**: 低
- **対応方法**: セレクターの追加・修正、フォールバックセレクターの追加

#### 原因2: 画像URLの相対パス解決（優先度: 中）
- **問題**: 相対パスが正しく解決されていない
- **修正難易度**: 低
- **対応方法**: URL解決ロジックの確認・修正

#### 原因3: 広告判定の誤判定（優先度: 中）
- **問題**: スレッド本文内の画像が広告として誤判定されている
- **修正難易度**: 低
- **対応方法**: `.t_b`内の画像は広告判定を緩和（最小サイズ30x30に変更）

#### 原因4: lazyload画像の読み込み不足（優先度: 中）
- **問題**: スクロール待機時間が不十分
- **修正難易度**: 中
- **対応方法**: 画像読み込み完了の確認を追加

#### 原因5: 画像属性の取得漏れ（優先度: 低）
- **問題**: `extract_img_src`関数で取得していない属性がある
- **修正難易度**: 低
- **対応方法**: 追加の属性を確認（`data-srcset`, `srcset`等）

#### 原因6: JavaScript実行後のDOM取得（優先度: 低）
- **問題**: BeautifulSoupで解析する前に、Playwrightで直接画像を取得していない
- **修正難易度**: 高
- **対応方法**: Playwrightの`page.query_selector_all`を使用して画像を直接取得

### 根本原因の特定

**問題1: `.t_h`要素が存在しないページ（URL1, URL2）**
- `.t_h`要素（投稿ヘッダー）がHTMLに存在しない
- `.t_b`要素（投稿本文）のみが存在する
- 現在のコードは`.t_h`要素を前提としているため、投稿ヘッダーが取得できない

**問題2: `.t_h`要素は存在するが画像が取得できない（URL3）**
- `.t_h`要素と`.t_b`要素は正しく検出されている
- しかし、画像が0枚のまま
- `.t_b`要素内に`<img>`タグが見つからない可能性

---

## 🎯 アプローチ比較と意思決定

### 比較した2つのアプローチ

#### アプローチ①: 既存Pythonファイルの修正
- **メリット**: 開発時間が短い、リスクが低い、要件定義への適合性が高い
- **デメリット**: 根本的な問題解決が難しい可能性
- **実装難易度**: 低〜中
- **開発時間**: 短い（数時間〜数日）

#### アプローチ②: Image Downloaderコピーアプリ + 対象範囲限定
- **メリット**: 確実な画像取得、根本的な解決
- **デメリット**: 開発時間が長い、リスクが高い、要件定義への適合性が低い
- **実装難易度**: 高
- **開発時間**: 長い（数週間〜数ヶ月）

### 決定: アプローチ①を優先

**理由**:
1. 段階的なアプローチが可能
2. リスクが低い
3. 開発効率が高い
4. 要件定義への適合性が高い

---

## 🔄 実装過程と課題

### フェーズ1: 簡単な修正（原因1, 2, 3）

**実施内容**:
- ✅ 要素選択の改善（セレクター追加、デバッグログ）
- ✅ URL解決のデバッグログ追加
- ✅ 広告判定の見直し（.t_b内の画像は広告判定を緩和）

**結果**: 画像が0枚のまま（改善していない）

### フェーズ2: フォールバック機能の実装

**実施内容**:
- ✅ フォールバックスクリプト（`画像一括取得_フォールバック.py`）を作成
- ✅ メインスクリプトから自動起動する仕組みを実装
- ✅ `.t_b`要素のみから抽出するロジックを実装

**結果**:
- URL1: 59枚の画像を取得成功 ✅
- URL2: 62枚の画像を取得成功 ✅
- URL3: 0枚（別の問題）❌

### フェーズ3: パターン選択システムの実装

**実施内容**:
- ✅ `extractors/`フォルダを作成
- ✅ パターンごとの抽出ロジックをモジュール化
- ✅ パターン判定ロジックを実装
- ✅ 動的モジュール読み込みを実装

**結果**: パターン選択システムが完成

---

## ✅ 最終的な解決策

### パターン選択システム（アプローチ②: サブロジック選択）

**決定理由**:
1. 「今後パターンが増える想定」という要件に最適
2. 保守性と拡張性が高い
3. デバッグとテストが容易
4. 各パターンが独立しているため、影響範囲が限定的

### 実装構造

```
extractors/
├── base.py                    # 基底クラスと共通ユーティリティ
├── pattern_detector.py        # パターン判定ロジック
├── pattern_loader.py          # 動的モジュール読み込み
├── pattern_standard.py         # パターン1: .t_h / .t_b 構造
├── pattern_t_b_only.py        # パターン2: .t_b のみ
├── pattern_generic_2ch.py     # パターン3: Generic 2ch blog format
├── pattern_dl_dt_dd.py        # パターン4: dl/dt/dd structure
└── pattern_fallback.py        # パターン5: フォールバック
```

### パターン判定の優先順位

1. **pattern_standard**: .t_h と .t_b の両方が存在
2. **pattern_t_b_only**: .t_b のみ存在
3. **pattern_generic_2ch**: Generic 2ch blog format
4. **pattern_dl_dt_dd**: dl/dt/dd structure
5. **pattern_fallback**: どのパターンにも該当しない場合

---

## 🏗️ システム設計の決定

### 統一ロジック vs サブロジック選択

**選択**: サブロジック選択（アプローチ②）

**比較結果**:

| 項目 | 統一ロジック | サブロジック選択 |
|------|-------------|-----------------|
| **拡張性** | ⚠️ 低い | ✅ 高い |
| **保守性** | ⚠️ 中程度 | ✅ 高い |
| **可読性** | ⚠️ 低い（複雑になる） | ✅ 高い |
| **デバッグ** | ⚠️ 困難 | ✅ 容易 |
| **テスト** | ⚠️ 複雑 | ✅ 容易 |
| **将来の拡張** | ❌ 既存コードの修正が必要 | ✅ 新規追加のみ |

### 実装方針

- クラスベースで各パターンを分離
- パターン選択ロジックを実装
- 各パターンごとにテストを実装
- 新しいパターンを追加する際は、新しいクラスを追加するだけ

---

## 📝 今後の開発・修正時の注意点

### 新しいパターンを追加する場合

1. **新しいパターンファイルを作成**
   ```
   extractors/pattern_new.py
   ```

2. **BaseExtractorを継承したクラスを実装**
   ```python
   from extractors.base import BaseExtractor
   
   class NewExtractor(BaseExtractor):
       def extract(self, soup: BeautifulSoup) -> List[Dict]:
           # 抽出ロジックを実装
           pass
   ```

3. **パターン判定ロジックを追加**
   ```python
   # extractors/pattern_detector.py
   def detect_extraction_pattern(soup: BeautifulSoup) -> str:
       # 新しいパターンの判定条件を追加
       if has_new_pattern(soup):
           return "pattern_new"
       ...
   ```

4. **パターン名を追加**
   - `extractors/__init__.py` に追加
   - 命名規則: `pattern_xxx` → `XxxExtractor`

### デバッグ時のポイント

1. **パターン判定の確認**
   - どのパターンで処理されたかをログで確認
   - `[INFO] Detected extraction pattern: pattern_xxx` を確認

2. **画像抽出の確認**
   - `extract_images_from_element()` の戻り値を確認
   - 広告判定の結果を確認
   - URL解決の結果を確認

3. **投稿保存の確認**
   - `posts.append()` が正しく実行されているか確認
   - `current_imgs` が正しく保存されているか確認

### よくある問題と対処法

#### 問題: 画像が0枚になる
- **確認事項**:
  1. パターンが正しく判定されているか
  2. `.t_h` / `.t_b`要素が存在するか
  3. 広告判定で除外されていないか
  4. URL解決が正しく行われているか

#### 問題: パターンが正しく判定されない
- **確認事項**:
  1. `pattern_detector.py` の判定条件を確認
  2. ページ構造が想定と異なる可能性
  3. 新しいパターンの判定条件を追加する必要がある可能性

#### 問題: インポートエラー
- **確認事項**:
  1. `extractors/` フォルダが存在するか
  2. `extractors/__init__.py` が存在するか
  3. 各パターンモジュールが存在するか

---

## 🔧 技術的な知見

### 広告判定の改善

**問題**: スレッド本文内の画像が広告として誤判定される

**解決策**:
- `.t_b`要素内の画像は広告判定を緩和
- 最小サイズの閾値を下げる（50x50 → 30x30）
- 親要素の判定ロジックを追加

### 要素選択の改善

**問題**: セレクターが該当ページの構造と一致していない

**解決策**:
- 複数のセレクターパターンを追加
- フォールバックセレクターの強化
- メイン記事要素の検索を優先

### 画像抽出の改善

**問題**: 画像が抽出できても投稿に保存されない

**解決策**:
- `.t_h`要素と`.t_b`要素をペアとして再構築
- `current_imgs`のリセットタイミングを確認
- 投稿保存のタイミングを確認

---

## 📊 テスト結果

### フォールバック機能のテスト結果

| URL | メインスクリプト | フォールバックスクリプト | 結果 |
|-----|------------------|--------------------------|------|
| URL1 (16141932) | 0枚 | **59枚** ✅ | **成功** |
| URL2 (16142958) | 0枚 | **62枚** ✅ | **成功** |
| URL3 (21661990) | 0枚 | 0枚 ❌ | 失敗（別の問題） |

### 結論

- フォールバック機能は正常に動作
- URL1, URL2で画像取得に成功
- URL3は別の問題（`.t_b`要素内に画像が存在しない可能性）

---

## 🎯 要件定義の整理

### 矛盾点の解消

**矛盾点**:
1. posts.txtのフォーマット構造
2. 画像命名規則（`画像_1.jpg` vs `画像1.jpg`）
3. スレ主IDの扱い
4. 出力順序と空行の扱い

**解決**:
- `要件定義.md` を最新の仕様として採用
- `画像取得システム.md` を `要件定義.md` に合わせて更新

---

## 💡 重要な教訓

### 1. 段階的なアプローチの重要性
- 簡単な修正から始める
- 解決しない場合、より複雑な修正を検討
- 大きな変更は最後の手段

### 2. デバッグログの重要性
- 問題の原因を特定するためにデバッグログが不可欠
- どのパターンで処理されたかを明確に記録
- 画像抽出の各ステップをログに記録

### 3. パターン分離の重要性
- 各パターンを独立したモジュールに分離
- 新しいパターンを追加する際、既存コードに影響しない
- 保守性と拡張性が向上

### 4. フォールバック機能の重要性
- メインロジックで失敗した場合、フォールバックを試行
- 複数のパターンを順次試行することで、成功率を向上

---

## 📚 参考資料

### 関連ドキュメント
- `要件定義.md`: 最新の要件定義
- `画像取得システム.md`: 現行仕様（As-Is）
- `README.md`: 使用方法

### コードファイル
- `画像一括取得.py`: メインスクリプト
- `extractors/`: パターンモジュール
- `画像一括取得_フォールバック.py`: 旧フォールバックスクリプト（参考用）

---

## 🔄 システムの進化

### 旧システム
- 単一のPythonファイル（`画像一括取得.py`）
- 複数のパターンを順次試行（`if not posts:`）
- フォールバックスクリプトを別ファイルで実装

### 新システム
- パターン選択システム（`extractors/`フォルダ）
- 動的モジュール読み込み
- パターン自動判定
- 出力フォルダの統一（`result_js/`）

---

## 🎯 まとめ

このナレッジファイルは、開発・検証過程で得られた知見をまとめたものです。次回以降の開発・修正時に、以下の点を参考にしてください：

1. **問題発見時**: 原因分析のフレームワークを活用
2. **アプローチ選択時**: 統一ロジック vs サブロジック選択の比較を参考
3. **実装時**: パターン選択システムの拡張方法を参考
4. **デバッグ時**: よくある問題と対処法を参考
5. **新規パターン追加時**: 拡張方法の手順を参考

---

**最終更新**: 2025年12月16日  
**次回更新**: 新しい問題や知見が得られた際に更新
